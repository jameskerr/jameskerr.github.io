<!DOCTYPE html>
<html>
  <title>Complex Sorting in ActiveRecord | James Kerr</title>
  <meta name="description" content="A Ruby, Elixir, and JavaScript developer in San Francisco, CA">
  <meta name="viewport" content="initial-scale=1">
  <meta name="og:image" content="http://jameskerr.info/assets/james_andrew_kerr_3-0af59e185323503bb247b34df7b35809.jpg">
  <meta name="og:url" content="http://jameskerr.info/sql/ruby/activerecord/2017/01/16/complex-sorting-in-activerecord.html">

	<script src="//use.typekit.net/cla0hon.js"></script>
	<script>try{Typekit.load();}catch(e){}</script>

  <link rel="stylesheet" href="/assets/site-da0a6cfca1dc709ba09d2d934c3235d2.css">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-52167003-1', 'auto');
    ga('send', 'pageview');
  </script>

  <body>
    <div id="drawer-overlay" class="drawer-overlay"></div>
    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">James <span class="k"> ){</span>err</a>

    <svg id="nav-menu" class="menu-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <path d="M0,2 30,2" stroke="#222" stroke-width="3"/>
      <path d="M0,10 30,10" stroke="#222" stroke-width="3"/>
      <path d="M0,18 30,18" stroke="#222" stroke-width="3"/>
    </svg>

    <nav class="site-nav">
  <ul>
  
    
    	
      <li ><a href="/">Home</a>
      </li><span class="slash">/</span>
    
  
    
    	
      <li ><a href="/work">Work</a>
      </li><span class="slash">/</span>
    
  
    
    	
      <li ><a href="/about">About</a>
      </li><span class="slash">/</span>
    
  
    
    	
      <li ><a href="/blog">Blog</a>
      </li><span class="slash">/</span>
    
  
    
    	
      <li ><a href="/contact">Contact</a>
      </li>
    
  
  </ul>
</nav>
  </div>

</header>


    <div class="page-content">
      <main class="post-content content">

  <header class="post-header wrapper">
    <h1 class="post-title">Complex Sorting in ActiveRecord</h1>
    <p class="post-meta">Jan 16, 2017</p>
  </header>

  <article class="post-body content">
    <p>I get excited about small objects when I program. I often open up files that are hundreds of lines long with mixed responsibilities and lots of complexity. I recently had an opportunity to make a small object with a single responsibility. The object would be used to build the SQL fragment that gets passed as a parameter to ActiveRecord&#39;s <code>.order()</code> method.</p>

<p><a href="http://guides.rubyonrails.org/active_record_querying.html#ordering">ActiveRecord&#39;s order method</a> will take multiple string sql fragments as the arguments like so:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">User</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;name DESC, email&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; SELECT &quot;users&quot;.* FROM &quot;users&quot; ORDER BY name DESC, email</span>
</code></pre></div>
<p>My table of data had several columns that the user could order by. Like in an Excel spreadsheet, they wanted the ordering of previous columns to persist when ordering by a new column.</p>

<p>For example, if I first ordered by name, then ordered by location, the table should first be ordered A-Z by location, then A-Z by name.</p>

<p>Something like this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">| Name    | Location | Hire Date |
+---------+----------+-----------+
  Andy    | Alabama  | 10/10/2016
  Anthony | Alabama  | 09/12/2014
  Betty   | Alabama  | 05/22/2015
</code></pre></div>
<p>There were also subtle differences with how we handled <code>NULL</code> values that needed to be addressed.</p>

<p>Normally, null values appear first when a column is sorted ascending. We wanted this reversed, appearing last when ascending and first when descending. The exception to the rule was the hire date column, where we wanted the nulls to show up first when ascending and last when descending.</p>

<p>The PostgreSQL syntax to do this is simply to supply <code>NULLS FIRST</code> or <code>NULLS LAST</code> to the statement.</p>

<p>Unfortunately, there were some empty strings in the location column that we wanted to treat the same as nulls.</p>

<p>The <a href="http://www.postgresqltutorial.com/postgresql-nullif/">syntax for this in PostgreSQL</a> is pretty simple as well <code>NULLIF(column_name, value)</code>. In our case, <code>NULLIF(location, &#39;&#39;)</code> would do the trick.</p>

<p>If the user asked to order first by <strong>name</strong> <em>ascending</em> then by <strong>hire_date</strong> <em>descending</em> then by <strong>location</strong> <em>descending</em>, the client would pass up parameters that look like this:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;sort_orders&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nt">&quot;by&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>      <span class="nt">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;asc&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nt">&quot;by&quot;</span><span class="p">:</span> <span class="s2">&quot;hire_date&quot;</span><span class="p">,</span> <span class="nt">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;desc&quot;</span><span class="p">},</span>
    <span class="p">{</span> <span class="nt">&quot;by&quot;</span><span class="p">:</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span>  <span class="nt">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;desc&quot;</span><span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>Based on these params, I needed to somehow generate code that looks like this:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">query</span><span class="o">.</span><span class="n">order</span><span class="p">(</span>
  <span class="s2">&quot;name ASC NULLS LAST&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hire_date DESC NULLS LAST&quot;</span><span class="p">,</span>
  <span class="s2">&quot;NULLIF(location, &#39;&#39;) DESC NULLS FIRST&quot;</span>
<span class="p">)</span>
</code></pre></div>
<p>I decided to make a small object called <code>OrderBy</code>. It is used like this:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">OrderBy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="ss">nulls</span><span class="p">:</span> <span class="ss">:reversed</span><span class="p">,</span> <span class="ss">null_if</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_sql</span>
<span class="c1"># =&gt; &quot;NULLIF(employees.job_location, &#39;&#39;) ASC NULLS LAST&quot;</span>
</code></pre></div>
<p>Its implementation is small and simple.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">OrderBy</span>
  <span class="kp">attr_accessor</span> <span class="ss">:direction</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="ss">direction</span><span class="p">:</span> <span class="ss">:asc</span><span class="p">,</span> <span class="ss">nulls</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">null_if</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="vi">@column</span>    <span class="o">=</span> <span class="n">column</span>
    <span class="vi">@direction</span> <span class="o">=</span> <span class="n">direction</span>
    <span class="vi">@nulls</span>     <span class="o">=</span> <span class="n">nulls</span>
    <span class="vi">@null_if</span>   <span class="o">=</span> <span class="n">null_if</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_sql</span>
    <span class="n">fragments</span> <span class="o">=</span> <span class="o">[</span><span class="n">column_sql</span><span class="p">,</span> <span class="n">direction_sql</span><span class="p">,</span> <span class="n">nulls_sql</span><span class="o">]</span>
    <span class="n">fragments</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">join</span> <span class="s1">&#39; &#39;</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="kp">attr_reader</span> <span class="ss">:column</span><span class="p">,</span> <span class="ss">:nulls</span><span class="p">,</span> <span class="ss">:null_if</span>

  <span class="k">def</span> <span class="nf">column_sql</span>
    <span class="k">if</span> <span class="n">null_if</span>
      <span class="s2">&quot;NULLIF(</span><span class="si">#{</span><span class="n">column</span><span class="si">}</span><span class="s2">, &#39;</span><span class="si">#{</span><span class="n">null_if</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
    <span class="k">else</span>
      <span class="n">column</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">direction_sql</span>
    <span class="n">direction</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">upcase</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">nulls_sql</span>
    <span class="k">if</span> <span class="n">nulls</span> <span class="o">==</span> <span class="ss">:reversed</span>
      <span class="n">asc?</span> <span class="p">?</span> <span class="s1">&#39;NULLS LAST&#39;</span> <span class="p">:</span> <span class="s1">&#39;NULLS FIRST&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">asc?</span>
    <span class="n">direction</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">downcase</span> <span class="o">==</span> <span class="s1">&#39;asc&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The controller would use the objects like so:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">ORDER_BY_MAP</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;name&#39;</span>      <span class="o">=&gt;</span> <span class="no">OrderBy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>     <span class="ss">nulls</span><span class="p">:</span> <span class="ss">:reversed</span><span class="p">,</span> <span class="ss">null_if</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
  <span class="s1">&#39;location&#39;</span>  <span class="o">=&gt;</span> <span class="no">OrderBy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="ss">nulls</span><span class="p">:</span> <span class="ss">:reversed</span><span class="p">,</span> <span class="ss">null_if</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
  <span class="s1">&#39;hire_date&#39;</span> <span class="o">=&gt;</span> <span class="no">OrderBy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;hire_date&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">index</span>
  <span class="n">query</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">*</span><span class="n">order_by_args</span><span class="p">)</span>
<span class="k">end</span>

<span class="kp">private</span>

<span class="k">def</span> <span class="nf">order_by_args</span>
  <span class="n">permitted_params</span><span class="o">[</span><span class="ss">:sort_orders</span><span class="o">].</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">param</span><span class="o">|</span>
    <span class="n">order_by_object</span>           <span class="o">=</span> <span class="no">ORDER_BY_MAP</span><span class="o">[</span><span class="n">param</span><span class="o">[</span><span class="ss">:by</span><span class="o">]]</span>
    <span class="n">order_by_object</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">param</span><span class="o">[</span><span class="ss">:direction</span><span class="o">]</span>
    <span class="n">order_by_object</span><span class="o">.</span><span class="n">to_sql</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">permitted_params</span>
  <span class="n">params</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">sort_orders</span><span class="p">:</span> <span class="o">[</span><span class="ss">:by</span><span class="p">,</span> <span class="ss">:direction</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>At the end of this, I have a small object that can be re-used anytime I need to order something in a non-trivial way. It has a single responsibility, it is easy to test, and it is comprehensible to the next developer that reads it.</p>

  </article>

  <div id="disqus_thread" class="wrapper"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'jameskerr'; // Required - Replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</main>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="navigation">
      <h3>Navigate</h3>
      <nav class="site-nav">
  <ul>
  
    
    	
      <li ><a href="/">Home</a>
      </li><span class="slash">/</span>
    
  
    
    	
      <li ><a href="/work">Work</a>
      </li><span class="slash">/</span>
    
  
    
    	
      <li ><a href="/about">About</a>
      </li><span class="slash">/</span>
    
  
    
    	
      <li ><a href="/blog">Blog</a>
      </li><span class="slash">/</span>
    
  
    
    	
      <li ><a href="/contact">Contact</a>
      </li>
    
  
  </ul>
</nav>
    </div>

    <div class="social-media">
      <h3>Social Media</h3>
      <ul>
        <li>
          <a href="https://github.com/jameskerr">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>

            <span class="username">Github</span>
          </a>
        </li>

        <li>
          <a href="https://twitter.com/jkerr838">
            <span class="icon  icon--twitter">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>

            <span class="username">Twitter</span>
          </a>
        </li>

        <li>
          <a href="https://www.linkedin.com/pub/james-kerr/37/636/388">
            <span class="icon icon--linked-in">
              <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" height="1000" width="1036" viewBox="0 0 1000 1036" enable-background="new 0 0 1000 1036" ><path d="M0 120q0-50 35-82.5t91-32.5q55 0 89 32 35 33 35 86 0 48-34 80-35 33-92 33l-1 0q-55 0-89-33t-34-83zm13 875l0-668l222 0l0 668l-222 0zm345 0l222 0l0-373q0-35 8-54 14-34 42.5-57.5t71.5-23.5q112 0 112 151l0 357l222 0l0-383q0-148-70-224.5t-185-76.5q-129 0-201 111l0 2l-1 0l1-2l0-95l-222 0q2 32 2 199t-2 469z"/>
              </svg>
            </span>
            <span class="username">Linked In</span>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/jkerr838">
          <span class="icon icon--facebook">

            <svg height="1000" width="857.143" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" height="1000" width="1036" viewBox="0 0 1000 857.143" enable-background="new 0 0 1000 857.143" ><path d="M729.306 512.308l12.834 -122.202h-110.484v-60.822q0 -27.342 8.649 -38.223t39.897 -10.881h61.38v-122.202h-97.65q-84.816 0 -121.644 40.176t-36.828 118.854v73.098h-73.098v122.202h73.098v354.33h146.196v-354.33h97.65zm127.782 -280.116v535.68q0 66.402 -47.151 113.553t-113.553 47.151h-535.68q-66.402 0 -113.553 -47.151t-47.151 -113.553v-535.68q0 -66.402 47.151 -113.553t113.553 -47.151h535.68q66.402 0 113.553 47.151t47.151 113.553z"/></svg>
          </span>
          <span class="username">Facebook</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="contact">
      <h3>Email</h3>
      <ul class="contact-list">
        <li><a href="mailto:jkerr838@gmail.com">jkerr838@gmail.com</a></li>
      </ul>
    </div>

  </div>

</footer>

    <script src="/assets/site-c0fa57ebf7504bcbc99c617cfad5e52a.js"></script>
  </body>
</html>
